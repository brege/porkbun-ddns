#!/bin/bash

# porkbun dynamic DNS update
SCRIPT_DIR="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
CONFIG_FILE="$SCRIPT_DIR/config.ini"
while getopts "c:" opt; do
    case $opt in
        c) CONFIG_FILE="$OPTARG" ;;
    esac
done

source "$CONFIG_FILE"
LOG_FILE="$data_dir/porkbun.log"
DEFAULT_CTX="${domain:-porkbun-ddns}"
LOG_TAG="${LOG_TAG:-porkbun-ddns}"
LOG_HOST="${LOG_HOST:-$(hostname)}"
LOGGER_BIN="$(command -v logger)"

append_line() {
    local raw="$1"
    local sys_ts
    sys_ts=$(date '+%b %e %H:%M:%S')
    printf '%s %s %s[%s]: %s\n' "$sys_ts" "$LOG_HOST" "$LOG_TAG" "$$" "$raw" >>"$LOG_FILE"
    if [ -n "$LOGGER_BIN" ]; then
        "$LOGGER_BIN" -t "${LOG_TAG}[$$]" -- "$raw"
    fi
}

dd_log() {
    local label="$1"
    local ctx="$2"
    local message="$3"
    local prefix
    prefix=$(printf '%-8s ' "${label}:")
    if [ -n "$ctx" ]; then
        printf -v line '%s[%s]> %s' "$prefix" "$ctx" "$message"
    else
        printf -v line '%s> %s' "$prefix" "$message"
    fi
    append_line "$line"
}

ctx_for() {
    local record="$1"
    if [ -n "$record" ]; then
        printf '%s' "$record"
    else
        printf '%s' "$DEFAULT_CTX"
    fi
}

# get current IP
CURRENT_IP=$(curl -s https://api.ipify.org)
if [ -z "$CURRENT_IP" ]; then
    dd_log "FAILED" "$DEFAULT_CTX" "updating ${DEFAULT_CTX}: nohost: unable to resolve current IP"
    exit 1
fi

dd_log "INFO" "$DEFAULT_CTX" "detected IPv4 address $CURRENT_IP"

# get current DNS records
records=$(curl -s -X POST "https://api.porkbun.com/api/json/v3/dns/retrieve/$domain" \
    -H "Content-Type: application/json" \
    -d "{\"apikey\":\"$dns_porkbun_key\",\"secretapikey\":\"$dns_porkbun_secret\"}")

# update A records with current IP if necessary
records_updated=0
records_already_correct=0

echo "$records" | grep -o '"id":"[0-9]*","name":"[^"]*","type":"A","content":"[^"]*"' | while IFS= read -r line; do
    record_id=$(echo "$line" | sed 's/.*"id":"\([0-9]*\)".*/\1/')
    record_name=$(echo "$line" | sed 's/.*"name":"\([^"]*\)".*/\1/')
    record_ip=$(echo "$line" | sed 's/.*"content":"\([^"]*\)".*/\1/')

    if [ "$record_ip" != "$CURRENT_IP" ]; then
        # Update this record to point to current IP
        # Porkbun expects the host portion for subdomains and no name field for the apex.
        if [ "$record_name" = "$domain" ]; then
            include_name_field=false
        else
            include_name_field=true
            record_host="$record_name"
            if [[ "$record_host" == *".$domain" ]]; then
                record_host="${record_host%.$domain}"
            fi
        fi

        if [ "$include_name_field" = true ]; then
            update_payload=$(cat <<EOF
{
    "apikey": "$dns_porkbun_key",
    "secretapikey": "$dns_porkbun_secret",
    "type": "A",
    "name": "$record_host",
    "content": "$CURRENT_IP",
    "ttl": "600"
}
EOF
)
        else
            update_payload=$(cat <<EOF
{
    "apikey": "$dns_porkbun_key",
    "secretapikey": "$dns_porkbun_secret",
    "type": "A",
    "content": "$CURRENT_IP",
    "ttl": "600"
}
EOF
)
        fi
        update_response=$(curl -s -X POST "https://api.porkbun.com/api/json/v3/dns/edit/$domain/$record_id" \
            -H "Content-Type: application/json" \
            -d "$update_payload")
        if echo "$update_response" | grep -q '"status":"SUCCESS"'; then
            dd_log "SUCCESS" "$(ctx_for "$record_name")" "updating $record_name: good: IP address set to $CURRENT_IP"
            records_updated=$((records_updated + 1))
        else
            dd_log "FAILED" "$(ctx_for "$record_name")" "updating $record_name: nohost: $update_response"
        fi
    else
        dd_log "SUCCESS" "$(ctx_for "$record_name")" "skipped: IPv4 address was already set to $CURRENT_IP"
        records_already_correct=$((records_already_correct + 1))
    fi
done

if [ "$records_updated" -eq 0 ] && [ "$records_already_correct" -gt 0 ]; then
    dd_log "INFO" "$DEFAULT_CTX" "all DNS records already correct"
elif [ "$records_updated" -gt 0 ]; then
    dd_log "INFO" "$DEFAULT_CTX" "updated $records_updated A record(s)"
fi

dd_log "INFO" "$DEFAULT_CTX" "DNS update completed"

# ensure proper ownership of log file
DATA_DIR_OWNER=$(stat -c '%U:%G' "$data_dir" 2>/dev/null)
if [ -n "$DATA_DIR_OWNER" ]; then
    chown "$DATA_DIR_OWNER" "$LOG_FILE" 2>/dev/null || true
fi
